<!DOCTYPE html>
<html>
  <head>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #333; }
      .sessions-container { margin-top: 20px; }
      .session-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background-color: #f9f9f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .session-info { flex: 1; }
      .session-info h3 { margin: 0 0 10px 0; }
      .hardware-details { color: #666; font-size: 14px; }
      button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover { background-color: #45a049; }
      .loading { color: #999; font-style: italic; }
      .error { color: #d9534f; }
    </style>
  </head>
  <body>
    <h2>RUNIT – Available Jupyter Sessions</h2>
    <div style="margin-bottom: 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <a href="https://runit-p5ah.onrender.com/auth/github" target="_blank" style="padding:8px 12px;background:#24292e;color:white;text-decoration:none;border-radius:6px;">Login with GitHub</a>
      <input id="tokenInput" type="text" placeholder="Paste JWT token here" style="flex:1; min-width:240px; padding:8px;" />
      <button onclick="saveToken()">Save Token</button>
      <small id="tokenStatus" style="color:#555; display:block; width:100%;">Token: not set</small>
    </div>
    <div id="sessions" class="sessions-container">
      <p class="loading">Loading sessions...</p>
    </div>

    <script>
      let currentAccessToken = null;
      let heartbeatInterval = null;

      function getAuthHeaders() {
        const token = localStorage.getItem('renterToken');
        if (!token) return {};
        return { 'Authorization': `Bearer ${token}` };
      }

      function saveToken() {
        const val = document.getElementById('tokenInput').value.trim();
        if (val) {
          localStorage.setItem('renterToken', val);
          document.getElementById('tokenStatus').textContent = 'Token: saved';
        } else {
          localStorage.removeItem('renterToken');
          document.getElementById('tokenStatus').textContent = 'Token: not set';
        }
      }

      function loadSavedToken() {
        const token = localStorage.getItem('renterToken');
        if (token) {
          document.getElementById('tokenInput').value = token;
          document.getElementById('tokenStatus').textContent = 'Token: saved';
        }
      }

      async function loadSessions() {
        try {
          const res = await fetch(
            "https://runit-p5ah.onrender.com/renter/sessions",
            { headers: getAuthHeaders() }
          );

          if (!res.ok) {
            document.getElementById("sessions").innerHTML =
              '<p class="error">Failed to load sessions</p>';
            return;
          }

          const sessions = await res.json();

          if (sessions.length === 0) {
            document.getElementById("sessions").innerHTML =
              '<p class="error">No sessions available</p>';
            return;
          }

          const html = sessions
            .map(
              (session, index) =>
                `
            <div class="session-card">
              <div class="session-info">
                <h3>Provider ${index + 1}</h3>
                <div class="hardware-details">
                  <strong>GPU:</strong> ${session.hardware?.gpu || "N/A"} | 
                  <strong>RAM:</strong> ${session.hardware?.ram_gb || "?"}GB | 
                  <strong>Price:</strong> $${session.pricing?.hourlyUsd || "?"}​/hr
                </div>
              </div>
              <button onclick="this.disabled=true; connectSession('${session.accessToken}')">
                Connect
              </button>
            </div>
          `
            )
            .join("");

          document.getElementById("sessions").innerHTML = html;
        } catch (err) {
          console.error("Error loading sessions:", err);
          document.getElementById("sessions").innerHTML =
            '<p class="error">Error loading sessions</p>';
        }
      }

      async function connectSession(accessToken) {
        currentAccessToken = accessToken;
        
        const url = `https://runit-p5ah.onrender.com/access/${accessToken}`;
        
        // Open Jupyter in new tab/window
        const jupyterWindow = window.open(url, "_blank");
        
        // Show status - heartbeat is now optional (only for tracking, not for keeping session alive)
        const statusDiv = document.createElement('div');
        statusDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:15px 20px;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:9999;';
        statusDiv.innerHTML = `
          <strong>✅ Connected!</strong><br>
          <small>Session will stay active until you close Jupyter</small><br>
          <button onclick="this.parentElement.remove()" style="margin-top:8px;background:white;color:#4CAF50;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">OK</button>
        `;
        document.body.appendChild(statusDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => statusDiv.remove(), 5000);
        
        // Optional: Send periodic heartbeat for tracking (not required for session lock)
        // This helps server know session is being used, but won't unlock if missed
        startHeartbeat(accessToken);
        
        // Monitor if Jupyter window is closed, then release
        if (jupyterWindow) {
          const checkClosed = setInterval(() => {
            if (jupyterWindow.closed) {
              console.log("[renter] Jupyter window closed, releasing session");
              clearInterval(checkClosed);
              releaseSession(accessToken);
              if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
              }
              currentAccessToken = null;
            }
          }, 2000); // Check every 2 seconds
        }
      }

      function startHeartbeat(accessToken) {
        // Stop any existing heartbeat
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
        }

        console.log("[renter] Starting heartbeat for session");

        // Send heartbeat every 30 seconds
        heartbeatInterval = setInterval(async () => {
          try {
            const res = await fetch(
              `https://runit-p5ah.onrender.com/renter/heartbeat/${accessToken}`,
              { method: "POST", headers: getAuthHeaders() }
            );
            if (res.ok) {
              console.log("[renter] ❤️ Heartbeat sent successfully");
            } else {
              console.error("[renter] Heartbeat failed:", res.status, await res.text());
            }
          } catch (err) {
            console.error("[renter] Heartbeat error:", err);
          }
        }, 30000);
        
        // Send first heartbeat immediately
        fetch(
          `https://runit-p5ah.onrender.com/renter/heartbeat/${accessToken}`,
          { method: "POST", headers: getAuthHeaders() }
        ).then(() => console.log("[renter] ❤️ Initial heartbeat sent"));
      }

      async function releaseSession(accessToken) {
        if (!accessToken) return;
        
        try {
          await fetch(
            `https://runit-p5ah.onrender.com/renter/release/${accessToken}`,
            { method: "POST", keepalive: true, headers: getAuthHeaders() }
          );
        } catch (err) {
          console.error("Release failed:", err);
        }
      }

      // Release session when user closes page
      window.addEventListener('beforeunload', () => {
        if (currentAccessToken) {
          releaseSession(currentAccessToken);
        }
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
        }
      });

      // Load sessions when page loads
      loadSavedToken();
      loadSessions();

      // Refresh sessions every 5 seconds
      setInterval(loadSessions, 5000);
    </script>
  </body>
</html>
